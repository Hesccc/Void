# Void 全局扫描模式使用指南

## 📖 概述

Void 现在支持两种扫描模式：

| 模式 | 适用场景 | 配置文件 |
|------|---------|---------|
| **普通模式** | 每个下载器独立管理自己的目录 | 使用config-examples.yaml |
| **全局模式** | 一个共享目录包含多个下载器的文件 | 使用config-global-example.yaml |

---

## 🎯 使用场景对比

### 普通模式（main.py）

**场景**：每个下载器使用独立的下载目录

```
QB01 → /data/qb01/
QB02 → /data/qb02/
TR01 → /data/tr01/
```

**行为**：
- QB01 只扫描 `/data/qb01/`，检查是否在 QB01 中做种
- QB02 只扫描 `/data/qb02/`，检查是否在 QB02 中做种
- 各下载器互不干扰

---

### 全局模式（main_global.py）⭐ **新功能**

**场景**：所有下载器共享同一个目录

```
QB01 → /data/  ┐
QB02 → /data/  ├─ 共享目录
TR01 → /data/  ┘
```

**行为**：
- 扫描整个 `/data/` 目录
- 检查每个文件是否在 **任意一个** 下载器中做种
- 只有不在 **所有** 下载器中的文件才标记为未做种

**优势**：
- ✅ 避免误删：文件只要在任一下载器中做种就不会被删除
- ✅ 集中管理：只需扫描一次共享目录
- ✅ 跨下载器检查：自动聚合所有下载器的做种信息

---

## 📝 配置方法

### 1. 复制配置模板

```bash
cp config-global-example.yaml config.yaml
```

### 2. 编辑配置文件

```yaml
# 启用全局扫描模式
global_scan:
  enabled: True
  scan_paths:
    - "/data"           # 要扫描的共享目录

# 配置所有下载器
services:
  - name: "QB01"
    type: "qbittorrent"
    host: "127.0.0.1"
    port: 8080
    username: "admin"
    password: "password1"
    path_mapping:
      - "/data": "/downloads"   # 本地路径: 容器内路径
  
  - name: "QB02"
    type: "qbittorrent"
    host: "192.168.1.100"
    port: 8081
    username: "admin"
    password: "password2"
    path_mapping:
      - "/data": "/data"
```

### 3. 运行全局扫描模式

```bash
# 测试运行（仅扫描不删除）
uv run main_global.py

# 或使用 Docker
docker run -d \
  --name void-global \
  -v /opt/config:/app/config \
  -v /data:/data \
  hescc/void:latest \
  python main_global.py
```

---

## 🔍 工作原理

### 全局扫描流程

```
1. 连接所有下载器
   ├─ QB01 → 获取做种列表
   ├─ QB02 → 获取做种列表
   └─ TR01 → 获取做种列表

2. 聚合做种文件
   所有下载器的做种文件 → 合并为全局做种集合

3. 扫描目录
   遍历 /data/ 目录中的所有文件

4. 检查每个文件
   文件 in 全局做种集合？
   ├─ 是 → 保留（在某个下载器中做种）
   └─ 否 → 标记为未做种

5. 处理未做种文件
   ├─ 仅扫描模式 → 发送通知报告
   └─ 自动删除模式 → 删除 + 发送通知
```

---

## 📊 日志示例

### 正常扫描日志

```
[全局扫描模式] 开始执行
[全局扫描模式] 下载器数量: 3
[全局扫描模式] 扫描目录: ['/data']
============================================================
[全局扫描] 开始聚合 3 个下载器的做种文件
[全局扫描] QB01: 找到 150 个做种文件
[全局扫描] QB02: 找到 200 个做种文件
[全局扫描] TR01: 找到 100 个做种文件
[全局扫描] 聚合完成，共 450 个做种文件
[全局扫描] 开始扫描 1 个目录
[全局扫描] 正在扫描: /data
[全局扫描] /data: 检查了 500 个文件
[全局扫描] 扫描完成，找到 50 个未做种文件
============================================================
[全局扫描模式] 完成，未做种文件: 50
```

---

## ⚙️ 配置选项详解

### global_scan 部分

| 选项 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `enabled` | Boolean | 是否启用全局扫描 | `True` / `False` |
| `scan_paths` | List | 要扫描的目录列表 | `["/data", "T:\\"]` |

### 路径映射说明
 
在全局模式下，`path_mapping` 的作用是**将下载器返回的路径（容器内路径）转换为宿主机实际可访问的路径**，以便 Void 程序能够找到并扫描这些文件。
 
```yaml
# 格式：  "宿主机路径": "容器内路径"
path_mapping:
  - "/data": "/downloads"   # Linux 示例
  - "T:\\": "/downloads"    # Windows 示例（注意必须使用双反斜杠）
```

---

## 🆚 模式选择建议

### 使用普通模式（main.py）当：

- ✅ 每个下载器有独立的下载目录
- ✅ 不同下载器存储不同类型的内容
- ✅ 需要分别管理不同下载器的文件

### 使用全局模式（main_global.py）当：

- ✅ 所有下载器共享同一个下载目录
- ✅ 想要集中清理未做种文件
- ✅ 需要跨下载器检查文件是否做种
- ✅ 有多个下载器但文件可能存储在同一位置

---

## ⚠️ 注意事项

1. **路径映射必须正确**
   - 确保每个下载器的 `path_mapping` 能正确映射到实际文件路径
   - 错误的映射可能导致无法识别做种文件

2. **不要混用两种模式**
   - 同一时间只运行一种模式
   - 避免同时运行 `main.py` 和 `main_global.py`

3. **首次使用建议**
   - 先设置 `enable_auto_remove: False`（仅报告模式）
   - 检查日志输出是否符合预期
   - 确认无误后再启用自动删除

4. **下载器连接**
   - 确保所有配置的下载器都能正常连接
   - 如果某个下载器连接失败，会记录错误但继续扫描

---

## 🔧 故障排除

### 问题：提示 "全局扫描模式未启用"

**解决**：
```yaml
# 确保配置文件中有以下内容
global_scan:
  enabled: True
```

### 问题：所有文件都被标记为未做种

**可能原因**：
1. 路径映射配置错误
2. 下载器连接失败
3. 下载器中没有任何做种任务

**排查**：
```bash
# 查看详细日志
tail -f logs/Void.log

# 检查做种文件数量
# 日志中应该看到类似：
# [全局扫描] QB01: 找到 XXX 个做种文件
```

### 问题：未找到预期的文件

**解决**：
- 检查 `scan_paths` 是否正确
- 检查 `excluded_paths` 是否排除了该目录
- 检查 `checkfile_size` 阈值是否过大

---

## 📚 更多帮助

- 普通模式文档：`README.md`
- 配置示例：`config-global-example.yaml`
- 问题反馈：GitHub Issues
